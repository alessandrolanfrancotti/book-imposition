<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>⛓️ Lil Imposer - Platinum Glow Edition ⛓️</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Impact', sans-serif; 
            background: radial-gradient(circle, #222 0%, #000 100%);
            color: #efefef; 
            display: flex; 
            justify-content: center; 
            padding: 40px; 
            margin: 0;
        }

        .gothic-text {
            font-family: 'UnifrakturCook', cursive;
        }

        /* THE GLOW PANEL */
        .panel { 
            background: #000;
            padding: 45px; 
            border-radius: 0px; 
            width: 100%; 
            max-width: 750px; 
            position: relative;
            
            /* Il Bagliore Bianco Intenso ma Corto */
            border: 2px solid #fff;
            box-shadow: 
                0 0 10px #fff,          /* Luce centrale */
                0 0 20px rgba(255,255,255,0.8), /* Bagliore medio */
                0 0 5px #fff inset;     /* Bagliore interno */
            
            /* Overlay metallico */
            background-image: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 100%);
        }

        h1 { 
            font-family: 'UnifrakturCook', cursive;
            background: linear-gradient(to bottom, #fff 0%, #888 48%, #fff 52%, #444 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center; 
            margin-bottom: 40px; 
            font-size: 6rem; 
            filter: drop-shadow(0 0 15px rgba(255,255,255,0.4));
            margin-top: 0;
            line-height: 1;
        }

        .section { 
            background: rgba(255, 255, 255, 0.03);
            padding: 25px; 
            border: 1px solid #fff;
            margin-bottom: 25px; 
            /* Anche le sezioni hanno un piccolo glow */
            box-shadow: 0 0 8px rgba(255,255,255,0.2);
        }

        .section-title { 
            font-family: 'UnifrakturCook', cursive;
            font-size: 2rem; 
            color: #fff; 
            margin-bottom: 15px; 
            display: block; 
            text-shadow: 0 0 10px #fff;
            border-bottom: 2px solid #fff;
        }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }

        label { 
            display: block; 
            font-size: 0.8rem; 
            color: #aaa; 
            margin-bottom: 8px; 
            text-transform: uppercase; 
            letter-spacing: 2px;
        }

        input, select { 
            width: 100%; 
            padding: 15px; 
            border: 1px solid #fff; 
            background: #000; 
            color: #fff; 
            font-family: 'Impact', sans-serif;
            font-size: 1.2rem;
            text-transform: uppercase;
            box-sizing: border-box;
            outline: none;
        }
        
        input:focus, select:focus {
            background: #111;
            box-shadow: 0 0 12px #fff;
        }

        #monitor { 
            margin-top: 15px; 
            font-family: 'Impact', sans-serif; 
            font-size: 1rem; 
            background: #111; 
            color: #fff; 
            padding: 15px; 
            border-left: 10px solid #fff;
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        .monitor-ok { color: #fff !important; text-shadow: 0 0 8px #fff; }
        .monitor-error { color: #ff0000 !important; border-left-color: #ff0000 !important; }

        .upload-zone { 
            border: 3px solid #fff; 
            padding: 50px; 
            text-align: center; 
            margin: 30px 0; 
            background: #000;
            cursor: pointer; 
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
            transition: 0.3s;
        }
        .upload-zone:hover { 
            box-shadow: 0 0 25px rgba(255,255,255,0.4);
            transform: scale(1.01);
        }
        .upload-zone span { font-size: 1.8rem; letter-spacing: 4px; color: #fff; text-shadow: 0 0 5px #fff; }

        button#runBtn { 
            background: #fff;
            color: #000; 
            border: none; 
            padding: 30px; 
            width: 100%; 
            font-family: 'UnifrakturCook', cursive;
            font-weight: 900; 
            cursor: pointer; 
            font-size: 3rem; 
            margin-top: 10px;
            box-shadow: 0 0 20px #fff;
            transition: 0.2s;
        }
        button#runBtn:hover { 
            background: #eee;
            box-shadow: 0 0 40px #fff;
            transform: translateY(-2px);
        }

        #log { 
            margin-top: 25px; 
            font-family: 'Courier New', monospace; 
            font-size: 0.75rem; 
            background: #000; 
            color: #666; 
            padding: 15px; 
            height: 80px; 
            overflow-y: auto; 
            border: 1px solid #222;
        }

        .hidden { display: none !important; }

        /* Flare decor */
        .flare {
            position: absolute;
            width: 1px;
            height: 1px;
            background: #fff;
            box-shadow: 0 0 40px 10px #fff;
            pointer-events: none;
        }

    </style>
</head>
<body>

<div class="panel">
    <div class="flare" style="top:0; left:0;"></div>
    <div class="flare" style="top:0; right:0;"></div>
    <div class="flare" style="bottom:0; left:0;"></div>
    <div class="flare" style="bottom:0; right:0;"></div>
    
    <h1>Lil Imposer</h1>
    
    <div class="section">
        <span class="section-title">Paper</span>
        <div class="grid">
            <div>
                <label>SIZES</label>
                <select id="sheetSelect" onchange="toggleCustomSheet(); checkFit();">
                    <option value="420,297">A3 </option>
                    <option value="450,320">SRA3</option>
                    <option value="594,420">A2</option>
                    <option value="500,700">50x70</option>
                    <option value="700,1000">70x100 (THE BIG BOSS)</option>
                    <option value="custom">CUSTOM</option>
                </select>
            </div>
            <div id="customSheetDims" class="grid hidden">
                <div><label>W mm</label><input type="number" id="customW" oninput="checkFit()"></div>
                <div><label>H mm</label><input type="number" id="customH" oninput="checkFit()"></div>
            </div>
        </div>
        <div id="monitor">> AWAITIN' THE MANUSCRIPT...</div>
    </div>

    <div class="section">
        <span class="section-title">Signatures</span>
        <label>SEQUENCE</label>
        <input type="text" id="sigInput" placeholder="...">
    </div>

    <div class="upload-zone" onclick="document.getElementById('pdfFile').click()">
        <input type="file" id="pdfFile" accept="application/pdf" style="display:none">
        <span class="gothic-text">DROP THE BOOK</span>
    </div>

    <button id="runBtn">Bless this File</button>
    
    <div id="log">READY TO STACK.</div>
</div>

<script>
    /* JavaScript perfettamente funzionante */
    const pt = (mm) => (mm * 72) / 25.4;
    const ptToMm = (p) => (p * 25.4) / 72;
    let loadedPdf = null;

    function toggleCustomSheet() {
        const val = document.getElementById('sheetSelect').value;
        const customDiv = document.getElementById('customSheetDims');
        if (val === 'custom') customDiv.classList.remove('hidden');
        else customDiv.classList.add('hidden');
    }

    function checkFit() {
        const monitor = document.getElementById('monitor');
        if (!loadedPdf) return;
        let sW, sH;
        if (document.getElementById('sheetSelect').value === 'custom') {
            sW = parseFloat(document.getElementById('customW').value) || 0;
            sH = parseFloat(document.getElementById('customH').value) || 0;
        } else { [sW, sH] = document.getElementById('sheetSelect').value.split(',').map(Number); }
        const firstPage = loadedPdf.getPages()[0];
        const pW_mm = ptToMm(firstPage.getWidth());
        const pH_mm = ptToMm(firstPage.getHeight());
        const totalW = (pW_mm * 2);
        if (sW >= totalW && sH >= pH_mm) {
            monitor.innerText = `> STATUS: FIT FOR A KING. ${pW_mm.toFixed(0)}x${pH_mm.toFixed(0)}mm ENTERS.`;
            monitor.className = "monitor-ok";
        } else {
            monitor.innerText = `> ERR: SHEET IS TOO WEAK.`;
            monitor.className = "monitor-error";
        }
    }

    const writeLog = (m) => {
        const l = document.getElementById('log');
        l.innerHTML += `> ${m}<br>`;
        l.scrollTop = l.scrollHeight;
    };

    document.getElementById('pdfFile').onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
            const arrayBuffer = await file.arrayBuffer();
            loadedPdf = await PDFLib.PDFDocument.load(arrayBuffer);
            writeLog(`LOADED ${loadedPdf.getPageCount()} PAGES.`);
            autoCalculateSignatures();
            checkFit();
        }
    };

    function autoCalculateSignatures() {
        if (!loadedPdf) return;
        let total = loadedPdf.getPageCount();
        if (total % 4 !== 0) total = Math.ceil(total / 4) * 4;
        let plan = [], tempTotal = total;
        while (tempTotal > 0) {
            if (tempTotal >= 32) { plan.push(16); tempTotal -= 16; }
            else if (tempTotal === 20) { plan.push(20); tempTotal = 0; }
            else if (tempTotal === 24) { plan.push(8, 16); tempTotal = 0; }
            else if (tempTotal === 28) { plan.push(12, 16); tempTotal = 0; }
            else if (tempTotal === 16) { plan.push(16); tempTotal = 0; }
            else { plan.push(tempTotal); tempTotal = 0; }
        }
        document.getElementById('sigInput').value = plan.join(', ');
        writeLog(`FLOW: ${plan.join(', ')}`);
    }

    document.getElementById('runBtn').onclick = async () => {
        if (!loadedPdf) return alert("UPLOAD THE HEAT FIRST.");
        try {
            writeLog("BLESSING PDF...");
            const { PDFDocument } = PDFLib;
            const outDoc = await PDFDocument.create();
            let sW_mm, sH_mm;
            if (document.getElementById('sheetSelect').value === 'custom') {
                sW_mm = parseFloat(document.getElementById('customW').value);
                sH_mm = parseFloat(document.getElementById('customH').value);
            } else { [sW_mm, sH_mm] = document.getElementById('sheetSelect').value.split(',').map(Number); }
            const sheetW = pt(sW_mm), sheetH = pt(sH_mm);
            const sigPlan = document.getElementById('sigInput').value.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
            const embeddedPages = await outDoc.embedPages(loadedPdf.getPages());
            let totalProcessed = 0;
            for (const sigSize of sigPlan) {
                for (let i = 0; i < sigSize / 2; i++) {
                    const sheet = outDoc.addPage([sheetW, sheetH]);
                    let lIdx = (i % 2 === 0) ? (totalProcessed + sigSize) - 1 - i : totalProcessed + i;
                    let rIdx = (i % 2 === 0) ? totalProcessed + i : (totalProcessed + sigSize) - 1 - i;
                    const draw = (idx, side) => {
                        if (idx >= embeddedPages.length) return;
                        const p = embeddedPages[idx];
                        const x = (side === 'left') ? (sheetW / 2) - p.width : (sheetW / 2);
                        const y = (sheetH - p.height) / 2;
                        sheet.drawPage(p, { x, y, width: p.width, height: p.height });
                    };
                    draw(lIdx, 'left'); draw(rIdx, 'right');
                }
                totalProcessed += sigSize;
            }
            const pdfBytes = await outDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            window.open(URL.createObjectURL(blob));
            writeLog("GLORY! IT IS DONE.");
        } catch (e) { writeLog(`❌ FUMBLED: ${e.message}`); }
    };
</script>
</body>
</html>
