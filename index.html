<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Book Imposer - Professional Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        h1 { text-align: center; color: #2c3e50; font-size: 1.5rem; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .field { display: flex; flex-direction: column; }
        label { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; color: #666; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.9rem; }
        .full-width { grid-column: span 2; }
        .upload-area { border: 2px dashed #3498db; padding: 20px; text-align: center; margin: 20px 0; border-radius: 8px; cursor: pointer; background: #f9feff; }
        button { background: #3498db; color: white; border: none; padding: 15px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; font-size: 1rem; }
        #log { margin-top: 15px; font-size: 0.8rem; background: #333; color: #0f0; padding: 10px; border-radius: 5px; height: 100px; overflow-y: auto; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìñ Book Imposer Pro</h1>
    
    <div class="grid">
        <div class="field full-width">
            <label>Formato Foglio Stampa (Larghezza x Altezza mm)</label>
            <div style="display:flex; gap:10px;">
                <input type="number" id="sheetW" value="420"> 
                <input type="number" id="sheetH" value="297">
                <select id="presetSheet" onchange="applyPreset()">
                    <option value="custom">Manuale</option>
                    <option value="420,297">A3</option>
                    <option value="450,320">SRA3</option>
                    <option value="1000,700">70x100</option>
                </select>
            </div>
        </div>

        <div class="field">
            <label>Pagina PDF (L mm)</label>
            <input type="number" id="pdfW" value="210">
        </div>
        <div class="field">
            <label>Pagina PDF (A mm)</label>
            <input type="number" id="pdfH" value="297">
        </div>

        <div class="field full-width">
            <label>Distanza tra le pagine (Gronda/Gutter mm)</label>
            <input type="number" id="gutter" value="0">
        </div>
    </div>

    <div class="upload-area" onclick="document.getElementById('fileIn').click()">
        <input type="file" id="fileIn" accept="application/pdf" style="display:none">
        <span id="fileName">Seleziona il file PDF</span>
    </div>

    <button id="goBtn">GENERA IMPOSIZIONE</button>
    <div id="log"></div>
</div>

<script>
    const mmToPt = (mm) => (mm * 72) / 25.4;

    function applyPreset() {
        const preset = document.getElementById('presetSheet').value;
        if (preset !== 'custom') {
            const [w, h] = preset.split(',');
            document.getElementById('sheetW').value = w;
            document.getElementById('sheetH').value = h;
        }
    }

    const log = (msg) => {
        const l = document.getElementById('log');
        l.style.display = 'block';
        l.innerHTML += `> ${msg}<br>`;
        l.scrollTop = l.scrollHeight;
    };

    document.getElementById('fileIn').onchange = (e) => {
        document.getElementById('fileName').innerText = e.target.files[0].name;
    };

    document.getElementById('goBtn').onclick = async () => {
        const file = document.getElementById('fileIn').files[0];
        if (!file) return alert("Carica un PDF!");

        try {
            log("Inizio...");
            const { PDFDocument } = PDFLib;
            const bytes = await file.arrayBuffer();
            const srcDoc = await PDFDocument.load(bytes);
            const outDoc = await PDFDocument.create();

            // Parametri dagli input
            const sW = mmToPt(parseFloat(document.getElementById('sheetW').value));
            const sH = mmToPt(parseFloat(document.getElementById('sheetH').value));
            const g = mmToPt(parseFloat(document.getElementById('gutter').value));
            
            let total = srcDoc.getPageCount();
            log(`Pagine originali: ${total}`);

            // Pareggio multiplo di 4
            while (total % 4 !== 0) {
                srcDoc.addPage([mmToPt(210), mmToPt(297)]);
                total = srcDoc.getPageCount();
            }
            log(`Pagine finali: ${total}`);

            const embeddedPages = await outDoc.embedPages(srcDoc.getPages());

            for (let i = 0; i < total / 2; i++) {
                const sheet = outDoc.addPage([sW, sH]);
                let lIdx, rIdx;
                
                // Logica Saddle Stitch
                if (i % 2 === 0) { // Fronte
                    lIdx = total - 1 - i; rIdx = i;
                } else { // Retro
                    lIdx = i; rIdx = total - 1 - i;
                }

                const draw = (emb, isLeft) => {
                    const dW = emb.width;
                    const dH = emb.height;
                    // Posizionamento con gutter
                    const x = isLeft 
                        ? (sW / 2 - dW) - (g / 2) 
                        : (sW / 2) + (g / 2);
                    const y = (sH - dH) / 2;

                    sheet.drawPage(emb, { x, y, width: dW, height: dH });
                };

                draw(embeddedPages[lIdx], true);
                draw(embeddedPages[rIdx], false);
            }

            const pdfBytes = await outDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = "imposizione_custom.pdf"; a.click();
            log("‚úÖ FATTO!");

        } catch (e) {
            log(`‚ùå ERRORE: ${e.message}`);
        }
    };
</script>
</body>
</html>
