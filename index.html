<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Book Imposer Pro V24 - 16/8 Standard</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #e0e0e0; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .panel { background: #1e1e1e; padding: 25px; border-radius: 12px; width: 100%; max-width: 700px; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h1 { color: #00d1b2; text-align: center; margin-bottom: 20px; font-size: 1.5rem; }
        .section { background: #262626; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #00d1b2; }
        .section-title { font-size: 0.8rem; font-weight: bold; color: #00d1b2; margin-bottom: 12px; display: block; text-transform: uppercase; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { display: block; font-size: 0.75rem; color: #aaa; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #444; background: #121212; color: #fff; box-sizing: border-box; }
        #monitor { margin-top: 10px; font-family: 'Courier New', monospace; font-size: 0.8rem; background: #000; color: #888; padding: 12px; border-radius: 5px; border: 1px solid #333; min-height: 40px; }
        .monitor-ok { color: #00ff00 !important; }
        .monitor-error { color: #ff4757 !important; }
        .upload-zone { border: 2px dashed #444; padding: 25px; text-align: center; margin: 20px 0; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .upload-zone:hover { border-color: #00d1b2; background: #1a1a1a; }
        button#runBtn { background: #00d1b2; color: #1a1a1a; border: none; padding: 18px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; font-size: 1rem; text-transform: uppercase; }
        #log { margin-top: 15px; font-family: 'Courier New', monospace; font-size: 0.7rem; background: #000; color: #00ff00; padding: 12px; border-radius: 5px; height: 100px; overflow-y: auto; border: 1px solid #333; }
    </style>
</head>
<body>

<div class="panel">
    <h1>ðŸ“– Book Imposer Pro V24 (Standard 16/8)</h1>
    
    <div class="section">
        <span class="section-title">1. Configurazione Stampa</span>
        <div class="grid">
            <div>
                <label>Formato Foglio Macchina</label>
                <select id="sheetSelect" onchange="toggleCustomSheet(); checkFit();">
                    <option value="700,1000">70x100 cm</option>
                    <option value="500,700">50x70 cm</option>
                    <option value="450,320">SRA3 (450x320 mm)</option>
                    <option value="420,297">A3 (420x297 mm)</option>
                    <option value="custom">-- PERSONALIZZA --</option>
                </select>
            </div>
            <div>
                <label>ModalitÃ  Imposizione</label>
                <select id="modeSelect" onchange="runAutoCalculate(); checkFit();">
                    <option value="16esimo_foglio">Solo 16esimi (4x2)</option>
                    <option value="8avo_foglio">Solo 8avi (2x2)</option>
                    <option value="ibrido">Ibrido (Ottimizzato 16+8)</option>
                    <option value="accavallato">Quartini accavallati (2-up)</option>
                </select>
            </div>
        </div>
        <div id="customSheetDims" class="grid" style="display:none; margin-top:10px">
            <div><label>L mm</label><input type="number" id="customW" oninput="checkFit()"></div>
            <div><label>A mm</label><input type="number" id="customH" oninput="checkFit()"></div>
        </div>
        <div id="monitor">> In attesa di PDF...</div>
    </div>

    <div class="section">
        <span class="section-title">2. Piano Segnature</span>
        <label>Sequenza Calcolata</label>
        <input type="text" id="sigInput" value="">
    </div>

    <div class="upload-zone" onclick="document.getElementById('pdfFile').click()">
        <input type="file" id="pdfFile" accept="application/pdf" style="display:none">
        <span id="fileStatus">Carica il PDF del libro</span>
    </div>

    <button id="runBtn">Genera Imposizione Professional</button>
    <div id="log">Pronto.</div>
</div>

<script>
    const pt = (mm) => (mm * 72) / 25.4;
    const ptToMm = (p) => (p * 25.4) / 72;
    let loadedPdf = null;

    function toggleCustomSheet() {
        const val = document.getElementById('sheetSelect').value;
        document.getElementById('customSheetDims').style.display = (val === 'custom') ? 'grid' : 'none';
    }

    function checkFit() {
        const monitor = document.getElementById('monitor');
        const mode = document.getElementById('modeSelect').value;
        if (!loadedPdf) return;
        let sW, sH;
        if (document.getElementById('sheetSelect').value === 'custom') {
            sW = parseFloat(document.getElementById('customW').value) || 0;
            sH = parseFloat(document.getElementById('customH').value) || 0;
        } else { [sW, sH] = document.getElementById('sheetSelect').value.split(',').map(Number); }
        
        const firstPage = loadedPdf.getPages()[0];
        const pW = ptToMm(firstPage.getWidth());
        const pH = ptToMm(firstPage.getHeight());
        
        let cols = 2, rows = 1;
        if (mode === '16esimo_foglio' || mode === 'ibrido') { cols = 4; rows = 2; }
        else if (mode === '8avo_foglio') { cols = 2; rows = 2; }

        let reqW = pW * cols;
        let reqH = pH * rows;

        if (sW >= reqW && sH >= reqH) {
            monitor.innerHTML = `> OK | Ingombro Segnatura: ${reqW.toFixed(1)}x${reqH.toFixed(1)} mm`;
            monitor.className = "monitor-ok";
        } else {
            monitor.innerHTML = `> ERRORE | Richiesto: ${reqW.toFixed(1)}x${reqH.toFixed(1)} mm`;
            monitor.className = "monitor-error";
        }
    }

    const writeLog = (m) => {
        const l = document.getElementById('log');
        l.innerHTML += `> ${m}<br>`;
        l.scrollTop = l.scrollHeight;
    };

    document.getElementById('pdfFile').onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
            document.getElementById('fileStatus').innerText = file.name;
            const buffer = await file.arrayBuffer();
            loadedPdf = await PDFLib.PDFDocument.load(buffer);
            writeLog(`PDF: ${loadedPdf.getPageCount()} pag.`);
            runAutoCalculate();
            checkFit();
        }
    };

    function runAutoCalculate() {
        if (!loadedPdf) return;
        let total = loadedPdf.getPageCount();
        const mode = document.getElementById('modeSelect').value;
        if (total % 4 !== 0) total = Math.ceil(total / 4) * 4;
        
        let plan = [];
        let temp = total;

        if (mode === '8avo_foglio') {
            while (temp > 0) { plan.push(8); temp -= 8; }
        } else {
            // Logica 16esimi + resti da 8 o 4 (No 12esimi)
            while (temp > 0) {
                if (temp >= 16) { plan.push(16); temp -= 16; }
                else if (temp >= 8) { plan.push(8); temp -= 8; }
                else { plan.push(4); temp -= 4; }
            }
        }
        document.getElementById('sigInput').value = plan.join(', ');
        writeLog(`Piano: ${plan.join(', ')}`);
    }

    document.getElementById('runBtn').onclick = async () => {
        if (!loadedPdf) return alert("Manca il file!");
        const mode = document.getElementById('modeSelect').value;
        const { PDFDocument, degrees } = PDFLib;
        const outDoc = await PDFDocument.create();
        
        let sW_mm, sH_mm;
        if (document.getElementById('sheetSelect').value === 'custom') {
            sW_mm = parseFloat(document.getElementById('customW').value);
            sH_mm = parseFloat(document.getElementById('customH').value);
        } else { [sW_mm, sH_mm] = document.getElementById('sheetSelect').value.split(',').map(Number); }
        
        const sheetW = pt(sW_mm), sheetH = pt(sH_mm);
        const embeddedPages = await outDoc.embedPages(loadedPdf.getPages());
        const sigPlan = document.getElementById('sigInput').value.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
        
        let totalProcessed = 0;

        for (let sigSize of sigPlan) {
            let subSigs = (sigSize === 20) ? [16, 4] : [sigSize];
            let currentOffset = totalProcessed;

            for (let subSize of subSigs) {
                let cols, rows, schemaB, schemaV;
                let activeMode = (subSize === 4) ? 'accavallato' : (subSize === 8) ? '8avo_foglio' : '16esimo_foglio';

                if (activeMode === 'accavallato') {
                    for (let i = 0; i < subSize / 2; i++) {
                        const sheet = outDoc.addPage([sheetW, sheetH]);
                        let lIdx = (i % 2 === 0) ? (currentOffset + subSize) - 1 - i : currentOffset + i;
                        let rIdx = (i % 2 === 0) ? currentOffset + i : (currentOffset + subSize) - 1 - i;
                        const draw = (idx, side) => {
                            if (idx >= embeddedPages.length) return;
                            const p = embeddedPages[idx];
                            const x = (side === 'left') ? (sheetW / 2) - p.width : (sheetW / 2);
                            sheet.drawPage(p, { x, y: (sheetH - p.height) / 2 });
                        };
                        draw(lIdx, 'left'); draw(rIdx, 'right');
                    }
                } else {
                    if (subSize === 16) {
                        cols = 4; rows = 2;
                        schemaB = [{i:4,r:180,c:0,row:1},{i:11,r:180,c:1,row:1},{i:8,r:180,c:2,row:1},{i:7,r:180,c:3,row:1},{i:3,r:0,c:0,row:0},{i:12,r:0,c:1,row:0},{i:15,r:0,c:2,row:0},{i:0,r:0,c:3,row:0}];
                        schemaV = [{i:6,r:180,c:0,row:1},{i:9,r:180,c:1,row:1},{i:10,r:180,c:2,row:1},{i:5,r:180,c:3,row:1},{i:1,r:0,c:0,row:0},{i:14,r:0,c:1,row:0},{i:13,r:0,c:2,row:0},{i:2,r:0,c:3,row:0}];
                    } else { // 8avo
                        cols = 2; rows = 2;
                        schemaB = [{i:4,r:180,c:0,row:1},{i:3,r:180,c:1,row:1},{i:5,r:0,c:0,row:0},{i:2,r:0,c:1,row:0}];
                        schemaV = [{i:1,r:180,c:0,row:1},{i:6,r:180,c:1,row:1},{i:0,r:0,c:0,row:0},{i:7,r:0,c:1,row:0}];
                    }

                    const bianca = outDoc.addPage([sheetW, sheetH]);
                    const volta = outDoc.addPage([sheetW, sheetH]);
                    const drawGrid = (page, schema) => {
                        schema.forEach(s => {
                            let realIdx = currentOffset + s.i;
                            if (realIdx >= embeddedPages.length) return;
                            const p = embeddedPages[realIdx];
                            const gridW = p.width * cols;
                            const gridH = p.height * rows;
                            const x = ((sheetW - gridW) / 2) + (s.c * p.width);
                            const y = ((sheetH - gridH) / 2) + (s.row * p.height);
                            page.drawPage(p, { x: s.r === 180 ? x + p.width : x, y: s.r === 180 ? y + p.height : y, rotate: degrees(s.r) });
                        });
                    };
                    drawGrid(bianca, schemaB); drawGrid(volta, schemaV);
                }
                currentOffset += subSize;
            }
            totalProcessed += sigSize;
        }
        const pdfBytes = await outDoc.save();
        window.open(URL.createObjectURL(new Blob([pdfBytes], { type: 'application/pdf' })));
        writeLog("âœ… PDF GENERATO!");
    };
</script>
</body>
</html>
