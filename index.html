<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>⛓️ Lil Imposer ⛓️</title>

  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">

  <style>
    :root {
      --chrome-gradient: linear-gradient(to bottom, #fff 0%, #888 48%, #fff 52%, #444 100%);
      --chrome-border: linear-gradient(145deg, #fff, #444, #fff, #888);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; overflow: hidden; }

    body {
      font-family: 'Impact', sans-serif;
      background: radial-gradient(circle, #222 0%, #000 100%);
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }

    .panel {
      background: #000;
      padding: clamp(20px, 4vh, 45px);
      width: 100%;
      max-width: 700px;
      max-height: 98vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      border: 4px solid;
      border-image: var(--chrome-border) 1;
      box-shadow: 0 0 15px #fff, 0 0 30px rgba(255,255,255,0.5), inset 0 0 10px #fff;
    }

    /* ---------- LOGO (cover) ---------- */
    .logo-wrap {
      height: clamp(90px, 18vh, 200px);
      width: 100%;
      margin: 0 0 15px 0;
      overflow: hidden;
    }
    .logo {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      object-position: center;
    }

    /* ---------- SECTIONS ---------- */
    .section {
      background: rgba(255, 255, 255, 0.02);
      padding: clamp(10px, 2vh, 20px);
      margin-bottom: clamp(10px, 2vh, 20px);
      border: 2px solid;
      border-image: var(--chrome-border) 1;
    }

    .section-title {
      font-family: 'UnifrakturCook', cursive;
      font-size: clamp(1.2rem, 3vh, 2rem);
      background: var(--chrome-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
      display: block;
    }

    label {
      display: block;
      font-size: 0.8rem;
      font-weight: bold;
      background: var(--chrome-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    input, select {
      width: 100%;
      padding: clamp(8px, 1.5vh, 15px);
      background: #000;
      color: #fff;
      font-family: 'Impact', sans-serif;
      font-size: clamp(1rem, 2vh, 1.2rem);
      text-transform: uppercase;
      border: 2px solid;
      border-image: var(--chrome-border) 1;
      outline: none;
    }

    /* ---------- TERMINAL MONITOR (fit check) ---------- */
    #monitor{
      margin-top: 10px;
      font-family: "Courier New", monospace;
      font-size: 0.8rem;
      background: #000;
      color: #888;
      padding: 12px;
      border-radius: 5px;
      border: 1px solid #333;
      min-height: 40px;
      line-height: 1.35;
    }
    .monitor-ok { color: #00ff00 !important; }
    .monitor-error { color: #ff4757 !important; }

    /* ---------- UPLOAD (cover image) ---------- */
    .upload-zone {
      background: transparent;
      border: none;
      padding: 0;
      margin-bottom: clamp(10px, 2vh, 20px);
      width: 100%;
      cursor: pointer;
      user-select: none;
    }
    .upload-wrap {
      height: clamp(90px, 14vh, 180px);
      width: 100%;
      overflow: hidden;
    }
    .upload-wrap img {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      object-position: center;
    }

    /* ---------- DOWNLOAD BUTTON (cover) ---------- */
    .btn-img {
      background: transparent;
      border: none;
      padding: 0;
      width: 100%;
      cursor: pointer;
    }
    .btn-wrap {
      height: clamp(90px, 14vh, 180px);
      width: 100%;
      overflow: hidden;
    }
    .btn-wrap img {
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      object-position: center;
    }

    /* ---------- NEW: SIZES ROW (Select 50% + W 25% + H 25%) ---------- */
    .sizes-row {
      display: flex;
      gap: 12px;              /* gutter */
      align-items: flex-end;  /* allinea i box in basso */
      flex-wrap: nowrap;
    }
    .sizes-row .col-50 { flex: 2 1 0; } /* ~50% */
    .sizes-row .col-25 { flex: 1 1 0; } /* ~25% */
    .sizes-row .col-50,
    .sizes-row .col-25 { min-width: 0; } /* evita overflow */

    /* Se lo schermo è davvero stretto, meglio andare a capo */
    @media (max-width: 520px) {
      .sizes-row { flex-wrap: wrap; }
      .sizes-row .col-50,
      .sizes-row .col-25 { flex: 1 1 100%; }
    }

    /* ---------- MISC ---------- */
    .hidden { display: none !important; }
  </style>
</head>

<body>
  <div class="panel">

    <!-- LOGO -->
    <div class="logo-wrap">
      <img class="logo" src="LILIMPOSER.png" alt="Lil Imposer">
    </div>

    <div class="section">
      <span class="section-title">Paper</span>

      <!-- TUTTO SU UNA RIGA: SIZES (50%) + W (25%) + H (25%) -->
      <div class="sizes-row">
        <div class="col-50">
          <label>SIZES</label>
          <select id="sheetSelect">
            <option value="210,297">A4</option>
            <option value="420,297">A3</option>
            <option value="450,320">SRA3</option>
            <option value="594,420">A2</option>
            <option value="500,700">50x70</option>
            <option value="700,1000">70x100</option>
            <option value="custom">CUSTOM</option>
          </select>
        </div>

        <div class="col-25" id="customWCol">
          <label>W mm</label>
          <input type="number" id="customW" />
        </div>

        <div class="col-25" id="customHCol">
          <label>H mm</label>
          <input type="number" id="customH" />
        </div>
      </div>

      <!-- MONITOR TERMINALE -->
      <div id="monitor">&gt; Carica un PDF per iniziare...</div>
    </div>

    <div class="section">
      <span class="section-title">Signatures</span>
      <label>SEQUENCE</label>
      <input type="text" id="sigInput" placeholder="SEQUENCE" />
    </div>

    <!-- UPLOAD (image) -->
    <div class="upload-zone" id="uploadZone">
      <input type="file" id="pdfFile" accept="application/pdf" class="hidden">
      <div class="upload-wrap">
        <img src="DROPTHEBOOK.png" alt="Drop The Book">
      </div>
    </div>

    <!-- DOWNLOAD (image) -->
    <button id="runBtn" class="btn-img">
      <div class="btn-wrap">
        <img src="DOWNLOAD.png" alt="Download">
      </div>
    </button>

  </div>

  <script>
    const pt = (mm) => (mm * 72) / 25.4;
    const ptToMm = (p) => (p * 25.4) / 72;

    let loadedPdf = null;

    const sheetSelect = document.getElementById('sheetSelect');
    const customW = document.getElementById('customW');
    const customH = document.getElementById('customH');
    const customWCol = document.getElementById('customWCol');
    const customHCol = document.getElementById('customHCol');

    const pdfFile = document.getElementById('pdfFile');
    const uploadZone = document.getElementById('uploadZone');
    const sigInput = document.getElementById('sigInput');
    const runBtn = document.getElementById('runBtn');
    const monitor = document.getElementById('monitor');

    function setCustomVisibility() {
      const isCustom = sheetSelect.value === 'custom';
      customWCol.classList.toggle('hidden', !isCustom);
      customHCol.classList.toggle('hidden', !isCustom);
      checkFit();
    }

    function getSheetMm() {
      if (sheetSelect.value === 'custom') {
        const w = parseFloat(customW.value) || 0;
        const h = parseFloat(customH.value) || 0;
        return [w, h];
      }
      return sheetSelect.value.split(',').map(Number);
    }

    // Monitor: controlla se il foglio contiene l’imposizione 2-up (left+right)
    function checkFit() {
      if (!loadedPdf) {
        monitor.textContent = "> Carica un PDF per iniziare...";
        monitor.className = "";
        return;
      }

      const [sW, sH] = getSheetMm();
      const firstPage = loadedPdf.getPages()[0];
      const pW = ptToMm(firstPage.getWidth());
      const pH = ptToMm(firstPage.getHeight());

      const reqW = pW * 2;
      const reqH = pH;

      if (sW >= reqW && sH >= reqH) {
        monitor.innerHTML = `> STATO: OK | Ingombro: ${reqW.toFixed(1)}×${reqH.toFixed(1)} mm`;
        monitor.className = "monitor-ok";
      } else {
        monitor.innerHTML = `> ERRORE: FOGLIO PICCOLO | Min: ${reqW.toFixed(1)}×${reqH.toFixed(1)} mm`;
        monitor.className = "monitor-error";
      }
    }

    function autoCalculateSignatures() {
      if (!loadedPdf) return;

      let total = loadedPdf.getPageCount();
      if (total % 4 !== 0) total = Math.ceil(total / 4) * 4;

      const plan = [];
      let tempTotal = total;

      while (tempTotal >= 16) {
        plan.push(16);
        tempTotal -= 16;
      }

      if (tempTotal > 0) {
        if (plan.length > 0) plan.splice(plan.length - 1, 0, tempTotal);
        else plan.push(tempTotal);
      }

      sigInput.value = plan.join(', ');
    }

    sheetSelect.addEventListener('change', setCustomVisibility);
    customW.addEventListener('input', checkFit);
    customH.addEventListener('input', checkFit);

    uploadZone.addEventListener('click', () => pdfFile.click());

    pdfFile.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const arrayBuffer = await file.arrayBuffer();
      loadedPdf = await PDFLib.PDFDocument.load(arrayBuffer);

      autoCalculateSignatures();
      checkFit();
    });

    runBtn.addEventListener('click', async () => {
      if (!loadedPdf) return alert("LOAD THE HEAT.");

      try {
        const { PDFDocument } = PDFLib;
        const outDoc = await PDFDocument.create();

        const [sW_mm, sH_mm] = getSheetMm();
        const sheetW = pt(sW_mm), sheetH = pt(sH_mm);

        const sigPlan = sigInput.value
          .split(',')
          .map(n => parseInt(n.trim(), 10))
          .filter(n => Number.isFinite(n) && n > 0);

        if (sigPlan.length === 0) return alert("INVALID SIGNATURE SEQUENCE.");

        const embeddedPages = await outDoc.embedPages(loadedPdf.getPages());

        let totalProcessed = 0;
        for (const sigSize of sigPlan) {
          for (let i = 0; i < sigSize / 2; i++) {
            const sheet = outDoc.addPage([sheetW, sheetH]);

            const lIdx = (i % 2 === 0)
              ? (totalProcessed + sigSize) - 1 - i
              : totalProcessed + i;

            const rIdx = (i % 2 === 0)
              ? totalProcessed + i
              : (totalProcessed + sigSize) - 1 - i;

            const draw = (idx, side) => {
              if (idx >= embeddedPages.length) return;
              const p = embeddedPages[idx];
              const x = (side === 'left') ? (sheetW / 2) - p.width : (sheetW / 2);
              const y = (sheetH - p.height) / 2;
              sheet.drawPage(p, { x, y, width: p.width, height: p.height });
            };

            draw(lIdx, 'left');
            draw(rIdx, 'right');
          }
          totalProcessed += sigSize;
        }

        const pdfBytes = await outDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        window.open(URL.createObjectURL(blob));
      } catch (e) {
        console.error(e);
        alert("SOMETHING BROKE. CHECK CONSOLE.");
      }
    });

    // init
    setCustomVisibility();
    checkFit();
  </script>
</body>
</html>
