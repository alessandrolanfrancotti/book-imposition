<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Book Imposer - Signature Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #eee; display: flex; justify-content: center; padding: 20px; }
        .panel { background: #2d2d2d; padding: 25px; border-radius: 12px; width: 100%; max-width: 550px; border: 1px solid #444; }
        h1 { color: #00d1b2; text-align: center; margin-bottom: 25px; }
        .group { background: #383838; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; color: #aaa; margin-bottom: 8px; }
        input, select { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #555; background: #222; color: #fff; box-sizing: border-box; }
        .upload-zone { border: 2px dashed #00d1b2; padding: 20px; text-align: center; margin: 20px 0; border-radius: 8px; cursor: pointer; }
        button { background: #00d1b2; color: #1a1a1a; border: none; padding: 15px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; font-size: 1rem; }
        #log { margin-top: 15px; font-family: monospace; font-size: 0.75rem; background: #000; color: #00ff00; padding: 10px; border-radius: 5px; height: 120px; overflow-y: auto; border: 1px solid #444; }
    </style>
</head>
<body>

<div class="panel">
    <h1>üìñ Book Imposer Pro</h1>
    
    <div class="group">
        <label>Formato Foglio di Stampa (Macchina)</label>
        <select id="sheetSelect">
            <option value="420,297">A3 (420x297 mm)</option>
            <option value="450,320">SRA3 (450x320 mm)</option>
            <option value="500,700">50x70 cm</option>
            <option value="700,1000">70x100 cm</option>
            <option value="210,297">A4 (210x297 mm)</option>
        </select>
    </div>

    <div class="group">
        <label>Piano Segnature (es: 16, 16, 8, 4)</label>
        <input type="text" id="sigInput" value="16" placeholder="Inserisci i fascicoli separati da virgola">
        <small style="color:#888; font-size:0.7rem;">Definisci come dividere le pagine del PDF.</small>
    </div>

    <div class="group">
        <label>Distanza tra le pagine / Gutter (mm)</label>
        <input type="number" id="gutterInput" value="0">
    </div>

    <div class="upload-zone" onclick="document.getElementById('pdfFile').click()">
        <input type="file" id="pdfFile" accept="application/pdf" style="display:none">
        <span id="fileStatus">Clicca per caricare il PDF</span>
    </div>

    <button id="runBtn">GENERA PDF IMPOSTO</button>
    <div id="log">Pronto all'uso.</div>
</div>

<script>
    const pt = (mm) => (mm * 72) / 25.4;

    const writeLog = (m) => {
        const l = document.getElementById('log');
        l.innerHTML += `> ${m}<br>`;
        l.scrollTop = l.scrollHeight;
    };

    document.getElementById('pdfFile').onchange = (e) => {
        document.getElementById('fileStatus').innerText = e.target.files[0].name;
    };

    document.getElementById('runBtn').onclick = async () => {
        const file = document.getElementById('pdfFile').files[0];
        if (!file) return alert("Seleziona un file!");

        try {
            writeLog("Inizializzazione libreria...");
            const { PDFDocument } = PDFLib;
            const srcBytes = await file.arrayBuffer();
            const srcDoc = await PDFDocument.load(srcBytes);
            const outDoc = await PDFDocument.create();

            const [sW_mm, sH_mm] = document.getElementById('sheetSelect').value.split(',').map(Number);
            const sheetW = pt(sW_mm);
            const sheetH = pt(sH_mm);
            const gutter = pt(parseFloat(document.getElementById('gutterInput').value));

            const sigPlan = document.getElementById('sigInput').value.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
            
            // EMBEDDING PREVENTIVO: Risolve l'errore NaN
            writeLog("Pre-elaborazione vettoriale pagine...");
            const srcPages = srcDoc.getPages();
            const embeddedPages = await outDoc.embedPages(srcPages);
            
            let totalProcessed = 0;
            const maxPages = embeddedPages.length;

            for (const sigSize of sigPlan) {
                writeLog(`Elaborazione segnatura: ${sigSize} pagine`);
                
                for (let i = 0; i < sigSize / 2; i++) {
                    const sheet = outDoc.addPage([sheetW, sheetH]);
                    
                    let lIdx, rIdx;
                    // Logica Saddle Stitch (Libretto) applicata alla singola segnatura
                    if (i % 2 === 0) { // Fronte
                        lIdx = (totalProcessed + sigSize) - 1 - i;
                        rIdx = totalProcessed + i;
                    } else { // Retro
                        lIdx = totalProcessed + i;
                        rIdx = (totalProcessed + sigSize) - 1 - i;
                    }

                    const drawPage = (idx, side) => {
                        if (idx >= maxPages) return; // Salta se la segnatura eccede il PDF
                        
                        const p = embeddedPages[idx];
                        // NO SCALING: Usiamo le dimensioni originali
                        const pW = p.width;
                        const pH = p.height;

                        const x = (side === 'left') 
                            ? (sheetW / 2 - pW) - (gutter / 2) 
                            : (sheetW / 2) + (gutter / 2);
                        const y = (sheetH - pH) / 2;

                        sheet.drawPage(p, { x, y, width: pW, height: pH });
                    };

                    drawPage(lIdx, 'left');
                    drawPage(rIdx, 'right');
                }
                totalProcessed += sigSize;
            }

            writeLog("Finalizzazione PDF...");
            const pdfBytes = await outDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "imposizione_professionale.pdf";
            a.click();
            writeLog("‚úÖ FILE GENERATO CON SUCCESSO!");

        } catch (e) {
            writeLog(`‚ùå ERRORE: ${e.message}`);
            console.error(e);
        }
    };
</script>
</body>
</html>
