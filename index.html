<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Book Imposer Pro - Signatures Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1e1e2e; color: #fff; padding: 20px; display: flex; justify-content: center; }
        .container { background: #2b2b3b; padding: 2rem; border-radius: 12px; width: 100%; max-width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h1 { text-align: center; color: #74b9ff; margin-top: 0; }
        .section { background: #35354a; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #74b9ff; }
        .section-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 10px; color: #a29bfe; display: block; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { font-size: 0.75rem; color: #ccc; margin-bottom: 5px; display: block; }
        input, select { width: 100%; padding: 8px; border-radius: 4px; border: none; background: #45455d; color: white; box-sizing: border-box; }
        .upload-area { border: 2px dashed #74b9ff; padding: 20px; text-align: center; margin: 20px 0; border-radius: 8px; cursor: pointer; }
        button { background: #00cec9; color: #1e1e2e; border: none; padding: 15px; border-radius: 6px; width: 100%; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        button:hover { background: #81ecec; }
        #log { margin-top: 15px; font-family: monospace; font-size: 0.75rem; background: #000; color: #00ff00; padding: 10px; border-radius: 5px; height: 120px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìñ Book Imposer Pro</h1>
    
    <div class="section">
        <span class="section-title">1. FORMATO FOGLIO DI STAMPA</span>
        <div class="grid">
            <div>
                <label>Preset</label>
                <select id="presetSheet" onchange="applyPreset()">
                    <option value="420,297">A3 (420x297)</option>
                    <option value="450,320">SRA3 (450x320)</option>
                    <option value="297,210">A4 (297x210)</option>
                    <option value="700,500">50x70</option>
                    <option value="1000,700">70x100</option>
                </select>
            </div>
            <div>
                <label>Gutter (mm)</label>
                <input type="number" id="gutter" value="0">
            </div>
        </div>
    </div>

    <div class="section">
        <span class="section-title">2. PIANO DI RILEGATURA (SEGNATURE)</span>
        <label>Specifica i fascicoli (es: "16, 16, 16, 16, 4" per un libro di 68 pagine)</label>
        <input type="text" id="sigPlan" value="16" placeholder="es. 16, 16, 4">
        <p style="font-size: 0.7rem; color: #aaa; margin-top: 5px;">* Ogni numero √® il numero di pagine di quella segnatura (deve essere multiplo di 4).</p>
    </div>

    <div class="upload-area" onclick="document.getElementById('fileIn').click()">
        <input type="file" id="fileIn" accept="application/pdf" style="display:none">
        <span id="fileName">Trascina qui il PDF originale</span>
    </div>

    <button id="goBtn">GENERA SEGNATURE</button>
    <div id="log">Pronto.</div>
</div>

<script>
    const mmToPt = (mm) => (mm * 72) / 25.4;

    function applyPreset() {
        // Preset gi√† gestiti dal valore della select
    }

    const log = (msg) => {
        const l = document.getElementById('log');
        l.innerHTML += `> ${msg}<br>`;
        l.scrollTop = l.scrollHeight;
    };

    document.getElementById('goBtn').onclick = async () => {
        const file = document.getElementById('fileIn').files[0];
        if (!file) return alert("Carica un PDF!");

        try {
            const { PDFDocument } = PDFLib;
            const bytes = await file.arrayBuffer();
            const srcDoc = await PDFDocument.load(bytes);
            const outDoc = await PDFDocument.create();

            const [sW_mm, sH_mm] = document.getElementById('presetSheet').value.split(',').map(Number);
            const sheetW = mmToPt(sW_mm);
            const sheetH = mmToPt(sH_mm);
            const gutter = mmToPt(parseFloat(document.getElementById('gutter').value));

            // Gestione Segnature
            const sigInput = document.getElementById('sigPlan').value;
            const sigPlan = sigInput.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
            
            let currentPageOffset = 0;
            const totalPdfPages = srcDoc.getPageCount();

            log(`Inizio elaborazione: ${totalPdfPages} pagine rilevate.`);

            for (const sigSize of sigPlan) {
                log(`Creazione segnatura da ${sigSize} pagine...`);
                
                // Per ogni segnatura (es. 16 pagine), facciamo un'imposizione a libretto interna
                for (let i = 0; i < sigSize / 2; i++) {
                    const sheet = outDoc.addPage([sheetW, sheetH]);
                    
                    let lIdx, rIdx;
                    // Logica Saddle Stitch applicata al blocco segnatura
                    if (i % 2 === 0) { // Fronte
                        lIdx = (currentPageOffset + sigSize) - 1 - i;
                        rIdx = currentPageOffset + i;
                    } else { // Retro
                        lIdx = currentPageOffset + i;
                        rIdx = (currentPageOffset + sigSize) - 1 - i;
                    }

                    const draw = async (idx, isLeft) => {
                        if (idx >= totalPdfPages) return; // Pagina bianca se fuori range
                        const [page] = await outDoc.copyPages(srcDoc, [idx]);
                        const pW = page.getWidth();
                        const pH = page.getHeight();

                        // COORDINATE - NO SCALING (1:1)
                        const x = isLeft 
                            ? (sheetW / 2 - pW) - (gutter / 2) 
                            : (sheetW / 2) + (gutter / 2);
                        const y = (sheetH - pH) / 2;

                        sheet.drawPage(page, { x, y, width: pW, height: pH });
                    };

                    await draw(lIdx, true);
                    await draw(rIdx, false);
                }
                currentPageOffset += sigSize;
            }

            const pdfBytes = await outDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `imposizione_libro.pdf`;
            a.click();
            log("‚úÖ SEGNATURE GENERATE!");

        } catch (e) {
            log(`‚ùå ERRORE: ${e.message}`);
        }
    };
</script>
</body>
</html>
