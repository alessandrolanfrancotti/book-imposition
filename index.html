<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Imposition Tool</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background: #f4f4f9; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; max-width: 400px; }
        input { margin: 20px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>

<div class="card">
    <h1>ðŸ“š Book Imposer</h1>
    <p>Carica un PDF per creare un'imposizione 2-up su foglio A3.</p>
    <input type="file" id="pdfInput" accept="application/pdf">
    <br>
    <button id="processBtn">Genera Imposizione</button>
    <p id="status"></p>
</div>

<script>
    const { PDFDocument } = PDFLib;

    document.getElementById('processBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('pdfInput');
        const status = document.getElementById('status');
        
        if (fileInput.files.length === 0) {
            alert("Seleziona un file!");
            return;
        }

        status.innerText = "Elaborazione in corso...";
        const file = fileInput.files[0];
        const arrayBuffer = await file.arrayBuffer();

        const srcDoc = await PDFDocument.load(arrayBuffer);
        const outDoc = await PDFDocument.create();
        
        // Formato A3 orizzontale (punti)
        const A3_W = 1191; 
        const A3_H = 842;

        const pageIndices = srcDoc.getPageIndices();
        const pages = await outDoc.copyPages(srcDoc, pageIndices);

        for (let i = 0; i < pages.length; i += 2) {
            const sheet = outDoc.addPage([A3_W, A3_H]);
            const p1 = pages[i];
            const p2 = pages[i+1];

            // Pagina 1
            sheet.drawPage(p1, {
                x: (A3_W / 2 - p1.getWidth()) / 2,
                y: (A3_H - p1.getHeight()) / 2
            });

            // Pagina 2 (se esiste)
            if (p2) {
                sheet.drawPage(p2, {
                    x: (A3_W / 2) + (A3_W / 2 - p2.getWidth()) / 2,
                    y: (A3_H - p2.getHeight()) / 2
                });
            }
        }

        const pdfBytes = await outDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "imposto_A3.pdf";
        link.click();
        status.innerText = "Completato!";
    });
</script>
</body>
</html>
